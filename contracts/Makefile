.PHONY: test build

ENTROPY = 1234

build: circuits/coin_send_cpp/ circuits/coin_withdraw_cpp/ circuits/coin_withdraw_0001.zkey circuits/coin_send_0001.zkey circuits/coin_withdraw_verif_key.json circuits/coin_send_verif_key.json src/CoinWithdrawVerifier.sol src/CoinSendVerifier.sol
	forge build

test: build
	# Pass inputs
	echo '{"a": 11, "b": 3}' > circuits/coin_withdraw_input.json
	echo '{"a": 11, "b": 3}' > circuits/coin_send_input.json

	cd circuits/coin_withdraw_cpp && make && ./coin_withdraw ../coin_withdraw_input.json ../coin_withdraw_witness.wtns
	cd circuits/coin_send_cpp && make && ./coin_send ../coin_send_input.json ../coin_send_witness.wtns

	# Generate proofs
	cd circuits && snarkjs groth16 prove coin_withdraw_0001.zkey coin_withdraw_witness.wtns coin_withdraw_proof.json coin_withdraw_public.json
	cd circuits && snarkjs groth16 prove coin_send_0001.zkey coin_send_witness.wtns coin_send_proof.json coin_send_public.json

	# Verify a proof on local machine
	cd circuits && snarkjs groth16 verify coin_withdraw_verif_key.json coin_withdraw_public.json coin_withdraw_proof.json
	cd circuits && snarkjs groth16 verify coin_send_verif_key.json coin_send_public.json coin_send_proof.json

	cd circuits && snarkjs generatecall coin_withdraw_public.json coin_withdraw_proof.json | sed "s/\"0x/uint256\(0x/g" | sed "s/\"/\)/g" > CoinWithdraw_calldata
	cd circuits && snarkjs generatecall coin_send_public.json coin_send_proof.json | sed "s/\"0x/uint256\(0x/g" | sed "s/\"/\)/g" > CoinSend_calldata

	for circ in CoinWithdraw CoinSend; do \
		CALLDATA=$$(cat circuits/$${circ}_calldata); \
		echo "// SPDX-License-Identifier: UNLICENSED \n\
			pragma solidity ^0.8.13; \n\
			import \"forge-std/Test.sol\"; \n\
			import \"../src/$${circ}Verifier.sol\"; \n\
			contract VerifierTest is Test { \n\
				$${circ}Verifier public verifier; \n\
				function setUp() public { \n\
					verifier = new $${circ}Verifier(); \n\
				} \n\
				function testVerifier() public view { \n\
				assert(verifier.verifyProof( \n\
						PLACEHOLDER \n\
					)); \n\
				} \n\
			}" | sed "s/PLACEHOLDER/$${CALLDATA}/g" > test/$${circ}Verifier.t.sol; \
	done;

	forge fmt
	forge test

circuits/coin_withdraw_verif_key.json: circuits/coin_withdraw_0001.zkey
	cd circuits && snarkjs zkey export verificationkey coin_withdraw_0001.zkey coin_withdraw_verif_key.json

circuits/coin_send_verif_key.json: circuits/coin_send_0001.zkey
	cd circuits && snarkjs zkey export verificationkey coin_send_0001.zkey coin_send_verif_key.json

circuits/coin_withdraw.r1cs circuits/coin_withdraw_cpp/: circuits/coin_withdraw.circom
	cd circuits && circom coin_withdraw.circom --r1cs --wasm --sym --c
	cd circuits/coin_withdraw_cpp && make

circuits/coin_send.r1cs circuits/coin_send_cpp/: circuits/coin_send.circom
	cd circuits && circom coin_send.circom --r1cs --wasm --sym --c
	cd circuits/coin_send_cpp && make

circuits/coin_withdraw_0001.zkey: circuits/coin_withdraw.r1cs circuits/pot_final.ptau
	cd circuits && snarkjs groth16 setup coin_withdraw.r1cs pot_final.ptau coin_withdraw_0000.zkey
	cd circuits && snarkjs zkey contribute coin_withdraw_0000.zkey coin_withdraw_0001.zkey --name="1st Contributor Name" --entropy=${ENTROPY} -v

circuits/coin_send_0001.zkey: circuits/coin_send.r1cs circuits/pot_final.ptau
	cd circuits && snarkjs groth16 setup coin_send.r1cs pot_final.ptau coin_send_0000.zkey
	cd circuits && snarkjs zkey contribute coin_send_0000.zkey coin_send_0001.zkey --name="1st Contributor Name" --entropy=${ENTROPY} -v

src/CoinWithdrawVerifier.sol: circuits/coin_withdraw_0001.zkey
	cd circuits && snarkjs zkey export solidityverifier coin_withdraw_0001.zkey ../src/CoinWithdrawVerifier.sol
	sed -i 's/Groth16Verifier/CoinWithdrawVerifier/' src/CoinWithdrawVerifier.sol

src/CoinSendVerifier.sol: circuits/coin_send_0001.zkey
	cd circuits && snarkjs zkey export solidityverifier coin_send_0001.zkey ../src/CoinSendVerifier.sol
	sed -i 's/Groth16Verifier/CoinSendVerifier/' src/CoinSendVerifier.sol

circuits/pot_final.ptau:
	# Generate Powers of Tau params
	cd circuits && snarkjs powersoftau new bn128 16 pot_0000.ptau -v
	cd circuits && snarkjs powersoftau contribute pot_0000.ptau pot_0001.ptau --name="First contribution" --entropy=${ENTROPY} -v
	cd circuits && snarkjs powersoftau prepare phase2 pot_0001.ptau pot_final.ptau -v

clean:
	rm -rf src/CoinWithdrawVerifier.sol test/CoinWithdrawVerifier.t.sol
	rm -rf src/CoinSendVerifier.sol test/CoinSendVerifier.t.sol
	cd circuits && rm -rf *.sym *.r1cs *.json *.zkey *.wtns coin_withdraw_js/ coin_withdraw_cpp/ coin_withdraw_calldata coin_send_calldata